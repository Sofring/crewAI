# CrewAI ä»»åŠ¡æ‰§è¡Œæœºåˆ¶è¯¦è§£

## ç›®å½•

1. æ•´ä½“æ¶æ„
   - æ ¸å¿ƒç»„ä»¶
   - ç»„ä»¶é—´å…³ç³»
   - æ•°æ®æµ

2. ä»»åŠ¡ç”Ÿå‘½å‘¨æœŸ
   - ä»»åŠ¡åˆ›å»º
   - ä»»åŠ¡éªŒè¯
   - ä»»åŠ¡æ‰§è¡Œ
   - ä»»åŠ¡å®Œæˆ

3. æ‰§è¡Œæœºåˆ¶è¯¦è§£
   ### 3.1 æ‰§è¡Œæµç¨‹æ¦‚è¿°

CrewAI æ”¯æŒä¸¤ç§ä¸»è¦çš„æ‰§è¡Œæµç¨‹ï¼š

1. **é¡ºåºæ‰§è¡Œ (Sequential)**
   - é€šè¿‡ `_run_sequential_process()` å®ç°
   - ä»»åŠ¡æŒ‰ç…§å®šä¹‰é¡ºåºä¾æ¬¡æ‰§è¡Œ
   - æ¯ä¸ªä»»åŠ¡å¿…é¡»æŒ‡å®šæ‰§è¡Œä»£ç†
   - æ”¯æŒåŒæ­¥å’Œå¼‚æ­¥ä»»åŠ¡æ··åˆæ‰§è¡Œ

2. **å±‚çº§æ‰§è¡Œ (Hierarchical)**
   - é€šè¿‡ `_run_hierarchical_process()` å®ç°
   - åˆ›å»ºç®¡ç†è€…ä»£ç†ï¼ˆManager Agentï¼‰ç»Ÿç­¹ä»»åŠ¡æ‰§è¡Œ
   - ç®¡ç†è€…å¯ä»¥å°†ä»»åŠ¡å§”æ´¾ç»™å…¶ä»–ä»£ç†
   - é€‚åˆå¤æ‚çš„å¤šä»£ç†åä½œåœºæ™¯

### 3.2 åŒæ­¥ä¸å¼‚æ­¥æ‰§è¡Œ

#### åŒæ­¥æ‰§è¡Œ
```python
def execute_sync(self, agent, context, tools):
    """åŒæ­¥æ‰§è¡Œä»»åŠ¡"""
    return self._execute_core(agent, context, tools)
```

- é€šè¿‡ `execute_sync()` æ–¹æ³•å®ç°
- ä»»åŠ¡æŒ‰é¡ºåºæ‰§è¡Œï¼Œæ¯ä¸ªä»»åŠ¡å®Œæˆåæ‰å¼€å§‹ä¸‹ä¸€ä¸ª
- æ”¯æŒä¸Šä¸‹æ–‡ä¼ é€’å’Œå·¥å…·ä½¿ç”¨
- é€‚åˆæœ‰å¼ºä¾èµ–å…³ç³»çš„ä»»åŠ¡åºåˆ—

#### å¼‚æ­¥æ‰§è¡Œ
```python
def execute_async(self, agent, context, tools):
    """å¼‚æ­¥æ‰§è¡Œä»»åŠ¡"""
    future = Future()
    threading.Thread(
        target=self._execute_task_async,
        args=(agent, context, tools, future),
    ).start()
    return future
```

- é€šè¿‡ `execute_async()` æ–¹æ³•å®ç°
- ä½¿ç”¨ Future å¯¹è±¡ç®¡ç†å¼‚æ­¥æ‰§è¡Œç»“æœ
- æ”¯æŒå¹¶è¡Œæ‰§è¡Œå¤šä¸ªä»»åŠ¡
- é€‚åˆç‹¬ç«‹æ€§å¼ºçš„ä»»åŠ¡

### 3.3 æ¡ä»¶ä»»åŠ¡æ‰§è¡Œ

æ¡ä»¶ä»»åŠ¡ï¼ˆConditionalTaskï¼‰æ˜¯ Task çš„ç‰¹æ®Šå­ç±»ï¼Œæä¾›äº†åŸºäºæ¡ä»¶çš„æ‰§è¡Œæ§åˆ¶ï¼š

```python
class ConditionalTask(Task):
    def should_execute(self, context: TaskOutput) -> bool:
        """åŸºäºä¸Šä¸‹æ–‡å†³å®šæ˜¯å¦æ‰§è¡Œä»»åŠ¡"""
        return self.condition(context)

    def get_skipped_task_output(self):
        """ä»»åŠ¡è¢«è·³è¿‡æ—¶çš„é»˜è®¤è¾“å‡º"""
        return TaskOutput(
            description=self.description,
            raw="",
            agent=self.agent.role if self.agent else "",
            output_format=OutputFormat.RAW,
        )
```

ä¸»è¦ç‰¹ç‚¹ï¼š
1. ç»§æ‰¿è‡ªåŸºç¡€ Task ç±»
2. é€šè¿‡ `condition` å‡½æ•°å†³å®šæ‰§è¡Œæ¡ä»¶
3. æä¾›è·³è¿‡ä»»åŠ¡æ—¶çš„é»˜è®¤è¾“å‡º
4. ä¸èƒ½ä½œä¸ºç¬¬ä¸€ä¸ªä»»åŠ¡ï¼ˆéœ€è¦ä¸Šä¸‹æ–‡ï¼‰

### 3.4 ä»»åŠ¡ä¾èµ–ç®¡ç†

CrewAI é€šè¿‡ä»¥ä¸‹æœºåˆ¶ç®¡ç†ä»»åŠ¡ä¾èµ–ï¼š

1. **ä¸Šä¸‹æ–‡ä¼ é€’**
```python
def _get_context(self, task: Task, task_outputs: List[TaskOutput]):
    """è·å–ä»»åŠ¡æ‰§è¡Œä¸Šä¸‹æ–‡"""
    context = (
        aggregate_raw_outputs_from_tasks(task.context)
        if task.context
        else aggregate_raw_outputs_from_task_outputs(task_outputs)
    )
    return context
```

2. **è¾“å‡ºèšåˆ**
```python
def aggregate_raw_outputs_from_task_outputs(task_outputs):
    """èšåˆå¤šä¸ªä»»åŠ¡è¾“å‡º"""
    dividers = "\n\n----------\n\n"
    context = dividers.join(output.raw for output in task_outputs)
    return context
```

3. **éªŒè¯è§„åˆ™**
- ä¸å…è®¸ä¾èµ–æœªæ¥ä»»åŠ¡
- å¼‚æ­¥ä»»åŠ¡ä¸èƒ½ä¾èµ–å…¶ä»–å¼‚æ­¥ä»»åŠ¡
- æ¡ä»¶ä»»åŠ¡å¿…é¡»æœ‰å‰ç½®ä»»åŠ¡æä¾›ä¸Šä¸‹æ–‡

### 3.5 æ‰§è¡Œæµç¨‹æ§åˆ¶

1. **ä»»åŠ¡å‡†å¤‡**
   - å·¥å…·å‡†å¤‡ï¼š`_prepare_tools()`
   - ä»£ç†åˆ†é…ï¼š`_get_agent_to_use()`
   - ä¸Šä¸‹æ–‡æ„å»ºï¼š`_get_context()`

2. **æ‰§è¡Œæ§åˆ¶**
   - æ¡ä»¶æ£€æŸ¥ï¼š`_handle_conditional_task()`
   - å¼‚æ­¥ç®¡ç†ï¼š`_process_async_tasks()`
   - ç»“æœå¤„ç†ï¼š`_process_task_result()`

3. **è¾“å‡ºå¤„ç†**
   - ç»“æœéªŒè¯ï¼šGuardrail æœºåˆ¶
   - æ ¼å¼è½¬æ¢ï¼šæ”¯æŒåŸå§‹æ–‡æœ¬ã€JSON å’Œ Pydantic æ¨¡å‹
   - æ—¥å¿—è®°å½•ï¼šæ‰§è¡ŒçŠ¶æ€å’Œç»“æœå­˜å‚¨

## 4. æ•°æ®æµä¸ä¸Šä¸‹æ–‡

### 4.1 ä»»åŠ¡é—´æ•°æ®ä¼ é€’

CrewAI å®ç°äº†çµæ´»çš„ä»»åŠ¡é—´æ•°æ®ä¼ é€’æœºåˆ¶ï¼š

1. **ä¸Šä¸‹æ–‡ä¼ é€’æœºåˆ¶**
   - é€šè¿‡ `context` å‚æ•°åœ¨ä»»åŠ¡é—´ä¼ é€’æ•°æ®
   - æ”¯æŒæ˜¾å¼æŒ‡å®šä¸Šä¸‹æ–‡ä»»åŠ¡åˆ—è¡¨
   - è‡ªåŠ¨èšåˆå‰åºä»»åŠ¡è¾“å‡ºä½œä¸ºä¸Šä¸‹æ–‡

2. **æ•°æ®æµè½¬è¿‡ç¨‹**
```python
def _get_context(self, task: Task, task_outputs: List[TaskOutput]):
    """è·å–ä»»åŠ¡æ‰§è¡Œä¸Šä¸‹æ–‡"""
    return (
        aggregate_raw_outputs_from_tasks(task.context)
        if task.context
        else aggregate_raw_outputs_from_task_outputs(task_outputs)
    )
```

3. **ä¸Šä¸‹æ–‡éªŒè¯è§„åˆ™**
   - é˜²æ­¢å¾ªç¯ä¾èµ–
   - éªŒè¯ä¸Šä¸‹æ–‡ä»»åŠ¡çš„æœ‰æ•ˆæ€§
   - ç¡®ä¿æ•°æ®æµå‘çš„æ­£ç¡®æ€§

### 4.2 ä¸Šä¸‹æ–‡ç®¡ç†

1. **ä¸Šä¸‹æ–‡èšåˆæ–¹æ³•**
```python
def aggregate_raw_outputs_from_task_outputs(task_outputs):
    """èšåˆå¤šä¸ªä»»åŠ¡è¾“å‡ºä¸ºä¸Šä¸‹æ–‡"""
    dividers = "\n\n----------\n\n"
    return dividers.join(output.raw for output in task_outputs)
```

2. **ä¸Šä¸‹æ–‡ç±»å‹**
   - æ˜¾å¼ä¸Šä¸‹æ–‡ï¼šé€šè¿‡ task.context æŒ‡å®š
   - éšå¼ä¸Šä¸‹æ–‡ï¼šè‡ªåŠ¨èšåˆå‰åºä»»åŠ¡è¾“å‡º
   - æ··åˆä¸Šä¸‹æ–‡ï¼šåŒæ—¶æ”¯æŒæ˜¾å¼å’Œéšå¼ä¸Šä¸‹æ–‡

3. **ä¸Šä¸‹æ–‡å¤„ç†æµç¨‹**
   - éªŒè¯ä¸Šä¸‹æ–‡æœ‰æ•ˆæ€§
   - èšåˆå¤šä»»åŠ¡è¾“å‡º
   - æ ¼å¼åŒ–ä¸Šä¸‹æ–‡å†…å®¹
   - ä¼ é€’ç»™æ‰§è¡Œä»£ç†

### 4.3 è¾“å‡ºå¤„ç†

1. **æ ‡å‡†åŒ–è¾“å‡º**
```python
class TaskOutput(BaseModel):
    """ä»»åŠ¡è¾“å‡ºæ ‡å‡†æ ¼å¼"""
    description: str
    raw: str
    pydantic: Optional[BaseModel]
    json_dict: Optional[Dict[str, Any]]
    agent: str
    output_format: OutputFormat
```

2. **è¾“å‡ºæ ¼å¼æ”¯æŒ**
   - åŸå§‹æ–‡æœ¬ï¼ˆRAWï¼‰ï¼šç›´æ¥è¾“å‡ºå­—ç¬¦ä¸²
   - JSONï¼šç»“æ„åŒ–æ•°æ®è¾“å‡º
   - Pydantic æ¨¡å‹ï¼šå¼ºç±»å‹æ•°æ®æ¨¡å‹

3. **è¾“å‡ºè½¬æ¢å¤„ç†**
```python
def _export_output(self, result):
    """è¾“å‡ºæ ¼å¼è½¬æ¢å¤„ç†"""
    if self.output_pydantic:
        pydantic_output = self.output_pydantic.model_validate_json(result)
        return pydantic_output, None
    elif self.output_json:
        json_output = json.loads(result)
        return None, json_output
    return None, None
```

4. **è¾“å‡ºéªŒè¯ä¸å¤„ç†**
   - Guardrail éªŒè¯æœºåˆ¶
   - æ ¼å¼è½¬æ¢å’Œè§„èŒƒåŒ–
   - é”™è¯¯å¤„ç†å’Œé‡è¯•
   - è¾“å‡ºæŒä¹…åŒ–

### 4.4 æ•°æ®æµç”Ÿå‘½å‘¨æœŸ

1. **æ•°æ®æµè½¬é˜¶æ®µ**
   - ä»»åŠ¡è¾“å…¥å‡†å¤‡
   - ä¸Šä¸‹æ–‡æ„å»ºå’Œä¼ é€’
   - ä»»åŠ¡æ‰§è¡Œå’Œè¾“å‡ºç”Ÿæˆ
   - è¾“å‡ºå¤„ç†å’Œå­˜å‚¨

2. **æ•°æ®ä¸€è‡´æ€§ä¿è¯**
   - äº‹åŠ¡æ€§å¤„ç†
   - çŠ¶æ€è¿½è¸ª
   - é”™è¯¯æ¢å¤
   - æ•°æ®æŒä¹…åŒ–

3. **ä¼˜åŒ–ç­–ç•¥**
   - ç¼“å­˜æœºåˆ¶
   - å¢é‡æ›´æ–°
   - é€‰æ‹©æ€§ä¼ é€’
   - æ•°æ®å‹ç¼©

## 5. é”™è¯¯å¤„ç†ä¸æ¢å¤

### 5.1 Guardrail æœºåˆ¶

CrewAI å®ç°äº†å¼ºå¤§çš„ Guardrail éªŒè¯æœºåˆ¶ï¼Œç¡®ä¿ä»»åŠ¡è¾“å‡ºçš„è´¨é‡å’Œæ­£ç¡®æ€§ï¼š

1. **Guardrail å®šä¹‰**
```python
class GuardrailResult(BaseModel):
    """ä»»åŠ¡ Guardrail éªŒè¯ç»“æœ"""
    success: bool
    result: Optional[Any] = None
    error: Optional[str] = None
```

2. **éªŒè¯æµç¨‹**
```python
if self.guardrail:
    guardrail_result = GuardrailResult.from_tuple(
        self.guardrail(task_output)
    )
    if not guardrail_result.success:
        if self.retry_count >= self.max_retries:
            raise Exception(
                f"Task failed guardrail validation after {self.max_retries} retries. "
                f"Last error: {guardrail_result.error}"
            )
        self.retry_count += 1
        return self._execute_core(agent, context, tools)
```

3. **éªŒè¯è§„åˆ™é…ç½®**
   - è‡ªå®šä¹‰éªŒè¯å‡½æ•°
   - è¾“å‡ºæ ¼å¼éªŒè¯
   - ç»“æœè½¬æ¢å¤„ç†
   - é”™è¯¯ä¿¡æ¯å®šåˆ¶

### 5.2 é‡è¯•ç­–ç•¥

CrewAI æä¾›äº†çµæ´»çš„é‡è¯•æœºåˆ¶æ¥å¤„ç†ä»»åŠ¡æ‰§è¡Œå¤±è´¥ï¼š

1. **é‡è¯•é…ç½®**
   - æœ€å¤§é‡è¯•æ¬¡æ•°è®¾ç½®
   - é‡è¯•é—´éš”æ§åˆ¶
   - é”™è¯¯æ¡ä»¶å®šåˆ¶
   - é‡è¯•çŠ¶æ€è¿½è¸ª

2. **é‡è¯•æµç¨‹**
```python
def _execute_core(self, agent, context, tools):
    try:
        # æ‰§è¡Œä»»åŠ¡...
    except Exception as e:
        if self.retry_count >= self.max_retries:
            raise Exception("Task failed after max retries")
        
        self.retry_count += 1
        return self._execute_core(agent, context, tools)
```

3. **é‡è¯•ç­–ç•¥ä¼˜åŒ–**
   - æŒ‡æ•°é€€é¿ç®—æ³•
   - é”™è¯¯ç±»å‹åŒºåˆ†
   - é‡è¯•æ¡ä»¶è¯„ä¼°
   - èµ„æºé‡Šæ”¾å¤„ç†

### 5.3 é”™è¯¯å¤„ç†æœºåˆ¶

1. **é”™è¯¯åˆ†ç±»**
   - æ‰§è¡Œé”™è¯¯ï¼ˆExecutionErrorï¼‰
   - éªŒè¯é”™è¯¯ï¼ˆValidationErrorï¼‰
   - å·¥å…·é”™è¯¯ï¼ˆToolErrorï¼‰
   - ä¸Šä¸‹æ–‡é”™è¯¯ï¼ˆContextErrorï¼‰

2. **é”™è¯¯å¤„ç†æµç¨‹**
```python
def on_tool_error(self, tool, tool_calling, e):
    """å·¥å…·æ‰§è¡Œé”™è¯¯å¤„ç†"""
    event_data = self._prepare_event_data(tool, tool_calling)
    events.emit(
        source=self,
        event=ToolUsageError(**{**event_data, "error": str(e)})
    )
```

3. **é”™è¯¯æ¢å¤ç­–ç•¥**
   - çŠ¶æ€å›æ»š
   - éƒ¨åˆ†ç»“æœä¿å­˜
   - æ›¿ä»£æ–¹æ¡ˆæ‰§è¡Œ
   - é”™è¯¯é€šçŸ¥æœºåˆ¶

### 5.4 ç›‘æ§ä¸æŠ¥å‘Š

1. **é”™è¯¯ç›‘æ§**
   - å®æ—¶é”™è¯¯è¿½è¸ª
   - æ€§èƒ½æŒ‡æ ‡æ”¶é›†
   - èµ„æºä½¿ç”¨ç›‘æ§
   - å¼‚å¸¸è¡Œä¸ºæ£€æµ‹

2. **æ—¥å¿—è®°å½•**
```python
def _store_execution_log(self, task, output, task_index):
    """è®°å½•ä»»åŠ¡æ‰§è¡Œæ—¥å¿—"""
    log = {
        "task": task,
        "output": {
            "description": output.description,
            "raw": output.raw,
            "agent": output.agent,
        },
        "task_index": task_index,
    }
    self._task_output_handler.update(task_index, log)
```

3. **æŠ¥å‘Šç”Ÿæˆ**
   - é”™è¯¯ç»Ÿè®¡åˆ†æ
   - æ‰§è¡ŒçŠ¶æ€æŠ¥å‘Š
   - æ€§èƒ½ç“¶é¢ˆè¯†åˆ«
   - ä¼˜åŒ–å»ºè®®ç”Ÿæˆ

### 5.5 æœ€ä½³å®è·µ

1. **é”™è¯¯é¢„é˜²**
   - è¾“å…¥éªŒè¯
   - å‰ç½®æ¡ä»¶æ£€æŸ¥
   - èµ„æºå¯ç”¨æ€§éªŒè¯
   - ä¾èµ–é¡¹æ£€æŸ¥

2. **é”™è¯¯æ¢å¤**
   - ä¼˜é›…é™çº§ç­–ç•¥
   - å¤‡ä»½æ–¹æ¡ˆå‡†å¤‡
   - çŠ¶æ€æŒä¹…åŒ–
   - å¹¶å‘æ§åˆ¶

3. **ç³»ç»Ÿå¥å£®æ€§**
   - è¶…æ—¶æ§åˆ¶
   - èµ„æºé™åˆ¶
   - è´Ÿè½½å‡è¡¡
   - ç†”æ–­æœºåˆ¶

## 6. ç›‘æ§ä¸é¥æµ‹

### 6.1 é¥æµ‹æ•°æ®æ”¶é›†

CrewAI å®ç°äº†å®Œæ•´çš„é¥æµ‹æ•°æ®æ”¶é›†æœºåˆ¶ï¼š

1. **é¥æµ‹æŒ‡æ ‡**
   - ä»»åŠ¡æ‰§è¡Œæ—¶é—´
   - å·¥å…·ä½¿ç”¨ç»Ÿè®¡
   - é”™è¯¯ç‡ç»Ÿè®¡
   - èµ„æºä½¿ç”¨æƒ…å†µ

2. **æ•°æ®æ”¶é›†æµç¨‹**
```python
def task_started(self):
    """è®°å½•ä»»åŠ¡å¼€å§‹"""
    self._execution_span = self._telemetry.task_started()
    self.start_time = datetime.datetime.now()
```

3. **æ€§èƒ½æŒ‡æ ‡**
   - å“åº”æ—¶é—´
   - ååé‡
   - é”™è¯¯ç‡
   - èµ„æºåˆ©ç”¨ç‡

### 6.2 æœ¬åœ°æ—¥å¿—è®°å½•

1. **æ—¥å¿—çº§åˆ«**
   - DEBUGï¼šè¯¦ç»†è°ƒè¯•ä¿¡æ¯
   - INFOï¼šå¸¸è§„æ“ä½œä¿¡æ¯
   - WARNINGï¼šè­¦å‘Šä¿¡æ¯
   - ERRORï¼šé”™è¯¯ä¿¡æ¯

2. **æ—¥å¿—å†…å®¹**
```python
def _log_task_start(self, task, agent_role):
    """è®°å½•ä»»åŠ¡å¼€å§‹æ—¥å¿—"""
    if self.verbose:
        self._printer.print(
            content=f"\nğŸ¯ Task: {task.description}\nğŸ‘¤ Agent: {agent_role}",
            color="blue",
        )
```

3. **æ—¥å¿—æ ¼å¼åŒ–**
   - æ—¶é—´æˆ³
   - ä»»åŠ¡æ ‡è¯†
   - ä»£ç†ä¿¡æ¯
   - æ‰§è¡ŒçŠ¶æ€

### 6.3 æ‰§è¡Œç»Ÿè®¡

1. **ç»Ÿè®¡æŒ‡æ ‡**
```python
class UsageMetrics(BaseModel):
    """ä½¿ç”¨ç»Ÿè®¡æŒ‡æ ‡"""
    prompt_tokens: int = 0
    completion_tokens: int = 0
    total_tokens: int = 0
    total_cost: float = 0.0
```

2. **æ•°æ®èšåˆ**
   - ä»»åŠ¡çº§åˆ«ç»Ÿè®¡
   - ä»£ç†çº§åˆ«ç»Ÿè®¡
   - å·¥å…·ä½¿ç”¨ç»Ÿè®¡
   - é”™è¯¯ç»Ÿè®¡åˆ†æ

3. **æ€§èƒ½åˆ†æ**
   - æ‰§è¡Œæ—¶é—´åˆ†æ
   - èµ„æºæ¶ˆè€—åˆ†æ
   - ç“¶é¢ˆè¯†åˆ«
   - ä¼˜åŒ–å»ºè®®

### 6.4 ç›‘æ§ç³»ç»Ÿ

1. **å®æ—¶ç›‘æ§**
   - ä»»åŠ¡æ‰§è¡ŒçŠ¶æ€
   - èµ„æºä½¿ç”¨æƒ…å†µ
   - é”™è¯¯å‘Šè­¦
   - æ€§èƒ½æŒ‡æ ‡

2. **ç›‘æ§é…ç½®**
```python
def configure_monitoring(self):
    """é…ç½®ç›‘æ§å‚æ•°"""
    self.monitoring = {
        "enabled": True,
        "interval": 60,  # ç§’
        "metrics": ["cpu", "memory", "disk"],
        "alerts": {
            "error_rate": 0.1,
            "response_time": 5000,
        }
    }
```

3. **å‘Šè­¦æœºåˆ¶**
   - é˜ˆå€¼è®¾ç½®
   - å‘Šè­¦çº§åˆ«
   - é€šçŸ¥æ¸ é“
   - å“åº”ç­–ç•¥

### 6.5 å¯è§†åŒ–ä¸æŠ¥å‘Š

1. **æ•°æ®å¯è§†åŒ–**
   - æ‰§è¡Œè¶‹åŠ¿å›¾
   - èµ„æºä½¿ç”¨å›¾
   - é”™è¯¯åˆ†å¸ƒå›¾
   - æ€§èƒ½çƒ­å›¾

2. **æŠ¥å‘Šç”Ÿæˆ**
   - å®šæœŸæŠ¥å‘Š
   - äº‹ä»¶æŠ¥å‘Š
   - æ€§èƒ½æŠ¥å‘Š
   - ä¼˜åŒ–å»ºè®®

3. **åˆ†æå·¥å…·**
   - è¶‹åŠ¿åˆ†æ
   - å¼‚å¸¸æ£€æµ‹
   - æ€§èƒ½è¯Šæ–­
   - å®¹é‡è§„åˆ’

## 7. æœ€ä½³å®è·µ

### 7.1 ä»»åŠ¡è®¾è®¡å»ºè®®

1. **ä»»åŠ¡ç²’åº¦**
   - ä¿æŒä»»åŠ¡åŸå­æ€§
   - æ˜ç¡®ä»»åŠ¡è¾¹ç•Œ
   - åˆç†æ‹†åˆ†å¤æ‚ä»»åŠ¡
   - é¿å…ä»»åŠ¡é—´å¼ºè€¦åˆ

2. **ä¸Šä¸‹æ–‡ç®¡ç†**
   - ç²¾ç®€ä¸Šä¸‹æ–‡å†…å®¹
   - é¿å…å†—ä½™æ•°æ®ä¼ é€’
   - åˆç†ä½¿ç”¨æ˜¾å¼ä¸Šä¸‹æ–‡
   - æ³¨æ„ä¸Šä¸‹æ–‡å¤§å°é™åˆ¶

3. **ä»£ç†åˆ†é…**
   - æ ¹æ®ä¸“é•¿åˆ†é…ä»»åŠ¡
   - é¿å…ä»£ç†è¿‡è½½
   - åˆç†è®¾ç½®å¹¶å‘åº¦
   - ä¼˜åŒ–ä»»åŠ¡åˆ†å‘ç­–ç•¥

### 7.2 å·¥å…·ä½¿ç”¨æŒ‡å—

1. **å·¥å…·é€‰æ‹©**
```python
def _prepare_tools(self, agent, task, tools):
    """å‡†å¤‡ä»»åŠ¡å·¥å…·"""
    # ä¼˜å…ˆä½¿ç”¨ä»»åŠ¡çº§åˆ«å·¥å…·
    tools_for_task = task.tools or agent.tools or []
    
    # å·¥å…·è½¬æ¢å’ŒéªŒè¯
    return to_langchain(tools_for_task)
```

2. **å·¥å…·é…ç½®**
   - åˆç†è®¾ç½®ç¼“å­˜ç­–ç•¥
   - å®ç°é”™è¯¯é‡è¯•æœºåˆ¶
   - æä¾›æ¸…æ™°çš„å·¥å…·æ–‡æ¡£
   - ä¼˜åŒ–å·¥å…·æ€§èƒ½

3. **æœ€ä½³å®è·µ**
   - é¿å…é‡å¤è°ƒç”¨
   - åˆç†ä½¿ç”¨ç¼“å­˜
   - å®ç°ä¼˜é›…é™çº§
   - ç›‘æ§å·¥å…·æ€§èƒ½

### 7.3 æ€§èƒ½ä¼˜åŒ–

1. **æ‰§è¡Œä¼˜åŒ–**
   - åˆç†ä½¿ç”¨å¼‚æ­¥æ‰§è¡Œ
   - ä¼˜åŒ–ä»»åŠ¡ä¾èµ–å…³ç³»
   - å®ç°æ™ºèƒ½ä»»åŠ¡è°ƒåº¦
   - æ§åˆ¶èµ„æºä½¿ç”¨

2. **å†…å­˜ç®¡ç†**
```python
def _cleanup_resources(self):
    """æ¸…ç†èµ„æº"""
    # é‡Šæ”¾ä¸´æ—¶èµ„æº
    self._temp_files.cleanup()
    
    # æ¸…ç†å†…å­˜ç¼“å­˜
    self.cache.clear()
    
    # é‡ç½®çŠ¶æ€
    self._reset_state()
```

3. **ç¼“å­˜ç­–ç•¥**
   - å®ç°å¤šçº§ç¼“å­˜
   - è®¾ç½®åˆç†çš„è¿‡æœŸæ—¶é—´
   - ä¼˜åŒ–ç¼“å­˜å‘½ä¸­ç‡
   - æ§åˆ¶ç¼“å­˜å¤§å°

### 7.4 å¸¸è§é—®é¢˜è§£å†³

1. **ä»»åŠ¡æ‰§è¡Œå¤±è´¥**
   - æ£€æŸ¥ä»»åŠ¡é…ç½®
   - éªŒè¯ä¸Šä¸‹æ–‡å®Œæ•´æ€§
   - ç¡®è®¤ä»£ç†å¯ç”¨æ€§
   - æŸ¥çœ‹é”™è¯¯æ—¥å¿—

2. **æ€§èƒ½é—®é¢˜**
   - åˆ†ææ‰§è¡Œç“¶é¢ˆ
   - ä¼˜åŒ–èµ„æºä½¿ç”¨
   - è°ƒæ•´å¹¶å‘ç­–ç•¥
   - å®æ–½æ€§èƒ½ç›‘æ§

3. **å·¥å…·é—®é¢˜**
   - éªŒè¯å·¥å…·å¯ç”¨æ€§
   - æ£€æŸ¥å‚æ•°æ­£ç¡®æ€§
   - å®ç°é”™è¯¯å¤„ç†
   - ä¼˜åŒ–å·¥å…·æ€§èƒ½

### 7.5 å¼€å‘å»ºè®®

1. **ä»£ç è´¨é‡**
   - éµå¾ªä»£ç è§„èŒƒ
   - ç¼–å†™å®Œæ•´æµ‹è¯•
   - ä¿æŒä»£ç ç®€æ´
   - åŠæ—¶é‡æ„ä¼˜åŒ–

2. **æ–‡æ¡£ç»´æŠ¤**
   - åŠæ—¶æ›´æ–°æ–‡æ¡£
   - æä¾›ä½¿ç”¨ç¤ºä¾‹
   - è®°å½•å…³é”®å†³ç­–
   - ç»´æŠ¤å˜æ›´æ—¥å¿—

3. **ç›‘æ§å‘Šè­¦**
   - è®¾ç½®åˆç†é˜ˆå€¼
   - å®ç°å¤šçº§å‘Šè­¦
   - å»ºç«‹å“åº”æœºåˆ¶
   - å®šæœŸä¼˜åŒ–è§„åˆ™

## æ–‡æ¡£è¯´æ˜

æœ¬æ–‡æ¡£è¯¦ç»†ä»‹ç»äº† CrewAI çš„ä»»åŠ¡æ‰§è¡Œæœºåˆ¶ï¼ŒåŒ…æ‹¬ä»»åŠ¡çš„åˆ›å»ºã€ç®¡ç†ã€æ‰§è¡Œæµç¨‹ä»¥åŠç›¸å…³çš„é”™è¯¯å¤„ç†å’Œç›‘æ§æœºåˆ¶ã€‚æ–‡æ¡£é¢å‘å¼€å‘è€…å’Œç³»ç»Ÿæ¶æ„å¸ˆï¼Œæ—¨åœ¨å¸®åŠ©è¯»è€…æ·±å…¥ç†è§£ CrewAI çš„ä»»åŠ¡å¤„ç†ç³»ç»Ÿã€‚

## 1. æ•´ä½“æ¶æ„

### 1.1 æ ¸å¿ƒç»„ä»¶

CrewAI çš„ä»»åŠ¡æ‰§è¡Œç³»ç»Ÿç”±ä»¥ä¸‹æ ¸å¿ƒç»„ä»¶æ„æˆï¼š

1. **Crewï¼ˆæ‰§è¡Œç»„ï¼‰**
   - ä½œä¸ºæ•´ä¸ªæ‰§è¡Œç³»ç»Ÿçš„æ ¸å¿ƒåè°ƒè€…
   - ç®¡ç†ä»»åŠ¡åˆ—è¡¨å’Œæ‰§è¡Œé¡ºåº
   - æä¾›åŒæ­¥ï¼ˆsequentialï¼‰å’Œå±‚çº§ï¼ˆhierarchicalï¼‰ä¸¤ç§æ‰§è¡Œæ¨¡å¼
   - è´Ÿè´£ä»»åŠ¡ä¸Šä¸‹æ–‡ä¼ é€’å’Œç»“æœèšåˆ

2. **Taskï¼ˆä»»åŠ¡ï¼‰**
   - å®šä¹‰å…·ä½“çš„æ‰§è¡Œä»»åŠ¡
   - åŒ…å«ä»»åŠ¡æè¿°ã€æœŸæœ›è¾“å‡ºã€æ‰§è¡Œä»£ç†ç­‰ä¿¡æ¯
   - æ”¯æŒåŒæ­¥å’Œå¼‚æ­¥æ‰§è¡Œæ¨¡å¼
   - æä¾›ä»»åŠ¡éªŒè¯å’Œé‡è¯•æœºåˆ¶

3. **ConditionalTaskï¼ˆæ¡ä»¶ä»»åŠ¡ï¼‰**
   - ç»§æ‰¿è‡ª Task
   - åŸºäºå‰åºä»»åŠ¡è¾“å‡ºå†³å®šæ˜¯å¦æ‰§è¡Œ
   - é€šè¿‡ should_execute() æ–¹æ³•å®ç°æ¡ä»¶åˆ¤æ–­
   - æä¾›ä»»åŠ¡è·³è¿‡æ—¶çš„é»˜è®¤è¾“å‡º

4. **TaskOutputï¼ˆä»»åŠ¡è¾“å‡ºï¼‰**
   - ç»Ÿä¸€çš„ä»»åŠ¡è¾“å‡ºæ ¼å¼
   - æ”¯æŒåŸå§‹æ–‡æœ¬ã€JSON å’Œ Pydantic æ¨¡å‹è¾“å‡º
   - è®°å½•æ‰§è¡Œä»£ç†å’Œè¾“å‡ºæ ¼å¼ä¿¡æ¯
   - æä¾›è¾“å‡ºæ ¼å¼è½¬æ¢æ–¹æ³•

### 1.2 ç»„ä»¶é—´å…³ç³»

1. **æ‰§è¡Œæµç¨‹å…³ç³»**
```python
Crew
 â”œâ”€â”€ ç®¡ç†å¤šä¸ª Task/ConditionalTask
 â”œâ”€â”€ é€šè¿‡ _execute_tasks() åè°ƒæ‰§è¡Œ
 â””â”€â”€ ç”Ÿæˆæœ€ç»ˆçš„ CrewOutput

Task
 â”œâ”€â”€ å…³è”ä¸€ä¸ªæ‰§è¡Œ Agent
 â”œâ”€â”€ ä½¿ç”¨ ToolsHandler ç®¡ç†å·¥å…·
 â””â”€â”€ äº§ç”Ÿ TaskOutput

ConditionalTask
 â”œâ”€â”€ ç»§æ‰¿ Task çš„åŸºç¡€åŠŸèƒ½
 â””â”€â”€ æ·»åŠ æ¡ä»¶æ‰§è¡Œé€»è¾‘
```

2. **æ•°æ®æµè½¬å…³ç³»**
```python
Task(è¾“å…¥) -> Agent(æ‰§è¡Œ) -> TaskOutput(è¾“å‡º) -> Crew(èšåˆ) -> CrewOutput(æœ€ç»ˆç»“æœ)
```

### 1.3 æ•°æ®æµ

1. **ä»»åŠ¡æ‰§è¡Œæµ**
   - Crew æ¥æ”¶ä»»åŠ¡åˆ—è¡¨å’Œé…ç½®
   - é€šè¿‡ kickoff() å¯åŠ¨æ‰§è¡Œæµç¨‹
   - æŒ‰ç…§ Process ç±»å‹ï¼ˆsequential/hierarchicalï¼‰æ‰§è¡Œä»»åŠ¡
   - æ”¶é›†å¹¶èšåˆä»»åŠ¡è¾“å‡º

2. **ä¸Šä¸‹æ–‡ä¼ é€’**
   - ä½¿ç”¨ aggregate_raw_outputs_from_tasks() èšåˆä¸Šä¸‹æ–‡ä»»åŠ¡è¾“å‡º
   - é€šè¿‡ _get_context() æ–¹æ³•åœ¨ä»»åŠ¡é—´ä¼ é€’æ•°æ®
   - æ”¯æŒåŒæ­¥å’Œå¼‚æ­¥ä»»åŠ¡çš„ä¸Šä¸‹æ–‡ç®¡ç†

3. **é”™è¯¯å¤„ç†æµ**
   - Task çº§åˆ«çš„ Guardrail éªŒè¯
   - ä»»åŠ¡é‡è¯•æœºåˆ¶
   - é”™è¯¯æ—¥å¿—è®°å½•å’Œé¥æµ‹æ•°æ®æ”¶é›†

### 1.4 å…³é”®ç‰¹æ€§

1. **æ‰§è¡Œæ¨¡å¼**
   - æ”¯æŒåŒæ­¥å’Œå¼‚æ­¥ä»»åŠ¡æ··åˆæ‰§è¡Œ
   - æä¾›æ¡ä»¶ä»»åŠ¡æ”¯æŒ
   - å®ç°ä»»åŠ¡é—´çš„ä¸Šä¸‹æ–‡å…±äº«

2. **é”™è¯¯å¤„ç†**
   - å†…ç½® Guardrail éªŒè¯æœºåˆ¶
   - å¯é…ç½®çš„é‡è¯•ç­–ç•¥
   - å®Œæ•´çš„é”™è¯¯è¿½è¸ª

3. **ç›‘æ§å’Œé¥æµ‹**
   - æœ¬åœ°æ—¥å¿—è®°å½•
   - è¿œç¨‹é¥æµ‹æ•°æ®æ”¶é›†
   - æ‰§è¡ŒæŒ‡æ ‡ç»Ÿè®¡

é€šè¿‡è¿™ç§æ¶æ„è®¾è®¡ï¼ŒCrewAI å®ç°äº†çµæ´»ä¸”å¯é çš„ä»»åŠ¡æ‰§è¡Œç³»ç»Ÿï¼Œèƒ½å¤Ÿæ”¯æŒå¤æ‚çš„å¤šä»£ç†åä½œåœºæ™¯ã€‚ç³»ç»Ÿçš„æ¨¡å—åŒ–è®¾è®¡ä½¿å¾—å„ç»„ä»¶èŒè´£æ¸…æ™°ï¼Œä¾¿äºæ‰©å±•å’Œç»´æŠ¤ã€‚

## 2. ä»»åŠ¡ç”Ÿå‘½å‘¨æœŸ

### 2.1 ä»»åŠ¡åˆ›å»º

1. **ä»»åŠ¡å®šä¹‰**
   ```python
   Task(
       description="ä»»åŠ¡æè¿°",
       expected_output="æœŸæœ›è¾“å‡º",
       agent=agent,
       context=context_tasks,
       async_execution=False
   )
   ```

2. **é…ç½®éªŒè¯**
   - é€šè¿‡ `process_model_config` å¤„ç†é…ç½®å‚æ•°
   - éªŒè¯å¿…éœ€å­—æ®µï¼ˆdescriptionã€expected_outputï¼‰
   - æ£€æŸ¥è¾“å‡ºæ ¼å¼è®¾ç½®ï¼ˆJSON/Pydanticï¼‰

3. **å·¥å…·å’Œä»£ç†ç»‘å®š**
   - è‡ªåŠ¨ç»§æ‰¿ä»£ç†çš„å·¥å…·é›†
   - æ”¯æŒä»»åŠ¡çº§åˆ«çš„å·¥å…·è¦†ç›–
   - éªŒè¯å·¥å…·å’Œä»£ç†çš„å…¼å®¹æ€§

### 2.2 ä»»åŠ¡éªŒè¯

1. **è¾“å…¥éªŒè¯**
   - éªŒè¯ä»»åŠ¡æè¿°å’ŒæœŸæœ›è¾“å‡ºçš„å®Œæ•´æ€§
   - æ£€æŸ¥æ¨¡æ¿å˜é‡çš„æ­£ç¡®æ€§
   - éªŒè¯æ–‡ä»¶è·¯å¾„çš„å®‰å…¨æ€§

2. **ä¸Šä¸‹æ–‡éªŒè¯**
   - ç¡®ä¿ä¸Šä¸‹æ–‡ä»»åŠ¡çš„æœ‰æ•ˆæ€§
   - é˜²æ­¢å¾ªç¯ä¾èµ–
   - éªŒè¯å¼‚æ­¥ä»»åŠ¡çš„ä¸Šä¸‹æ–‡é™åˆ¶

3. **Guardrail é…ç½®**
   - éªŒè¯ guardrail å‡½æ•°ç­¾å
   - æ£€æŸ¥è¿”å›ç±»å‹æ³¨è§£
   - ç¡®ä¿é”™è¯¯å¤„ç†æœºåˆ¶çš„æ­£ç¡®æ€§

### 2.3 ä»»åŠ¡æ‰§è¡Œ

1. **æ‰§è¡Œå‡†å¤‡**
   ```python
   def _execute_core(self, agent, context, tools):
       # åˆå§‹åŒ–æ‰§è¡Œç¯å¢ƒ
       self.start_time = datetime.datetime.now()
       self._execution_span = self._telemetry.task_started()
       
       # è®¾ç½®ä¸Šä¸‹æ–‡å’Œå·¥å…·
       self.prompt_context = context
       tools = tools or self.tools or []
   ```

2. **æ‰§è¡Œæ¨¡å¼**
   - **åŒæ­¥æ‰§è¡Œ**ï¼šç›´æ¥ç­‰å¾…ä»»åŠ¡å®Œæˆ
   - **å¼‚æ­¥æ‰§è¡Œ**ï¼šé€šè¿‡ Future å¯¹è±¡ç®¡ç†
   - **æ¡ä»¶æ‰§è¡Œ**ï¼šåŸºäºå‰åºä»»åŠ¡ç»“æœåˆ¤æ–­

3. **ç»“æœå¤„ç†**
   ```python
   # è¾“å‡ºæ ¼å¼è½¬æ¢
   pydantic_output, json_output = self._export_output(result)
   
   # åˆ›å»ºæ ‡å‡†è¾“å‡ºå¯¹è±¡
   task_output = TaskOutput(
       raw=result,
       pydantic=pydantic_output,
       json_dict=json_output,
       agent=agent.role
   )
   ```

### 2.4 ä»»åŠ¡å®Œæˆ

1. **ç»“æœéªŒè¯**
   - æ‰§è¡Œ Guardrail éªŒè¯
   - å¤„ç†éªŒè¯å¤±è´¥çš„é‡è¯•é€»è¾‘
   - è½¬æ¢è¾“å‡ºæ ¼å¼

2. **èµ„æºæ¸…ç†**
   - è®°å½•ç»“æŸæ—¶é—´
   - æ¸…ç†é¥æµ‹è¿½è¸ª
   - é‡Šæ”¾ä¸´æ—¶èµ„æº

3. **å›è°ƒå¤„ç†**
   - æ‰§è¡Œç”¨æˆ·å®šä¹‰çš„å›è°ƒå‡½æ•°
   - ä¿å­˜è¾“å‡ºæ–‡ä»¶
   - æ›´æ–°æ‰§è¡Œç»Ÿè®¡

### 2.5 é”™è¯¯å¤„ç†

1. **é‡è¯•æœºåˆ¶**
   ```python
   if not guardrail_result.success:
       if self.retry_count >= self.max_retries:
           raise Exception("Task failed after max retries")
       
       self.retry_count += 1
       return self._execute_core(agent, context, tools)
   ```

2. **é”™è¯¯æ¢å¤**
   - ä¿å­˜éƒ¨åˆ†æ‰§è¡Œç»“æœ
   - è®°å½•é”™è¯¯ä¿¡æ¯
   - é€šçŸ¥ç›‘æ§ç³»ç»Ÿ

3. **çŠ¶æ€ç»´æŠ¤**
   - æ›´æ–°ä»»åŠ¡çŠ¶æ€
   - è®°å½•æ‰§è¡ŒæŒ‡æ ‡
   - ä¿å­˜é”™è¯¯æ—¥å¿—
